<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPS Analytics Dashboard - NATPAC Travel Survey</title>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Leaflet for maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Heatmap plugin -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .dashboard-header {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
        }
        
        .dashboard-title {
            font-size: 32px;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }
        
        .dashboard-subtitle {
            color: #666;
            font-size: 16px;
        }
        
        .real-time-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .real-time-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .real-time-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }
        
        .real-time-label {
            color: #999;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }
        
        .real-time-value {
            font-size: 32px;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        
        .real-time-unit {
            color: #666;
            font-size: 14px;
        }
        
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .chart-card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
        }
        
        .chart-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .chart-icon {
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
        }
        
        #map {
            height: 400px;
            border-radius: 15px;
            margin-top: 20px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .stat-title {
            font-size: 14px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }
        
        .stat-change {
            font-size: 12px;
            display: inline-block;
            padding: 4px 8px;
            border-radius: 6px;
        }
        
        .stat-change.positive {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .stat-change.negative {
            background: #ffebee;
            color: #c62828;
        }
        
        .control-panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }
        
        .btn {
            padding: 10px 20px;
            border-radius: 10px;
            border: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .btn-secondary {
            background: #f5f5f5;
            color: #333;
        }
        
        .btn-secondary:hover {
            background: #e0e0e0;
        }
        
        .insights-container {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
            margin-bottom: 30px;
        }
        
        .insight-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }
        
        .insight-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        
        .insight-text {
            color: #666;
            font-size: 14px;
        }
        
        @media (max-width: 768px) {
            .charts-container {
                grid-template-columns: 1fr;
            }
            
            .real-time-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 200px;
            color: #999;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="dashboard-header">
        <h1 class="dashboard-title">üõ∞Ô∏è GPS Analytics Dashboard</h1>
        <p class="dashboard-subtitle">Real-time travel analytics with detailed GPS tracking insights</p>
    </div>
    
    <!-- Control Panel -->
    <div class="control-panel">
        <button class="btn btn-primary" onclick="startGPSTracking()">
            <span>üìç</span> Start GPS Tracking
        </button>
        <button class="btn btn-secondary" onclick="stopGPSTracking()">
            <span>‚èπÔ∏è</span> Stop Tracking
        </button>
        <button class="btn btn-secondary" onclick="generateAnalytics()">
            <span>üìä</span> Generate Analytics
        </button>
        <button class="btn btn-secondary" onclick="exportReport()">
            <span>üì•</span> Export Report
        </button>
        <button class="btn btn-secondary" onclick="simulateTrip()">
            <span>üéÆ</span> Simulate Trip
        </button>
    </div>
    
    <!-- Real-time GPS Data -->
    <div class="real-time-container">
        <div class="real-time-card">
            <div class="real-time-label">Current Speed</div>
            <div class="real-time-value pulse" id="currentSpeed">0</div>
            <div class="real-time-unit">km/h</div>
        </div>
        <div class="real-time-card">
            <div class="real-time-label">Distance Covered</div>
            <div class="real-time-value" id="totalDistance">0.00</div>
            <div class="real-time-unit">km</div>
        </div>
        <div class="real-time-card">
            <div class="real-time-label">GPS Accuracy</div>
            <div class="real-time-value" id="gpsAccuracy">¬±10</div>
            <div class="real-time-unit">meters</div>
        </div>
        <div class="real-time-card">
            <div class="real-time-label">Satellites</div>
            <div class="real-time-value" id="satellites">8</div>
            <div class="real-time-unit">connected</div>
        </div>
    </div>
    
    <!-- Statistics Grid -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-header">
                <span class="stat-title">Average Speed</span>
                <div class="stat-icon" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white;">‚ö°</div>
            </div>
            <div class="stat-value" id="avgSpeed">0.0</div>
            <span class="stat-change positive">‚Üë 12% from last trip</span>
        </div>
        
        <div class="stat-card">
            <div class="stat-header">
                <span class="stat-title">Trip Duration</span>
                <div class="stat-icon" style="background: linear-gradient(135deg, #ff6b6b, #ffd93d); color: white;">‚è±Ô∏è</div>
            </div>
            <div class="stat-value" id="duration">0</div>
            <span class="stat-change">minutes</span>
        </div>
        
        <div class="stat-card">
            <div class="stat-header">
                <span class="stat-title">Stops Made</span>
                <div class="stat-icon" style="background: linear-gradient(135deg, #4ecdc4, #44a08d); color: white;">üõë</div>
            </div>
            <div class="stat-value" id="stops">0</div>
            <span class="stat-change positive">Optimized route</span>
        </div>
        
        <div class="stat-card">
            <div class="stat-header">
                <span class="stat-title">Eco Score</span>
                <div class="stat-icon" style="background: linear-gradient(135deg, #8bc34a, #4caf50); color: white;">üåø</div>
            </div>
            <div class="stat-value" id="ecoScore">85</div>
            <span class="stat-change positive">Good efficiency</span>
        </div>
    </div>
    
    <!-- Charts Container -->
    <div class="charts-container">
        <div class="chart-card">
            <div class="chart-title">
                <div class="chart-icon">üìà</div>
                Speed Profile Over Time
            </div>
            <canvas id="speedChart"></canvas>
        </div>
        
        <div class="chart-card">
            <div class="chart-title">
                <div class="chart-icon">üìä</div>
                Speed Distribution
            </div>
            <canvas id="speedZonesChart"></canvas>
        </div>
        
        <div class="chart-card">
            <div class="chart-title">
                <div class="chart-icon">üìâ</div>
                Distance Accumulation
            </div>
            <canvas id="distanceChart"></canvas>
        </div>
        
        <div class="chart-card">
            <div class="chart-title">
                <div class="chart-icon">üèîÔ∏è</div>
                Elevation Profile
            </div>
            <canvas id="elevationChart"></canvas>
        </div>
        
        <div class="chart-card">
            <div class="chart-title">
                <div class="chart-icon">‚ö°</div>
                Acceleration Events
            </div>
            <canvas id="accelerationChart"></canvas>
        </div>
        
        <div class="chart-card">
            <div class="chart-title">
                <div class="chart-icon">üéØ</div>
                Efficiency Metrics
            </div>
            <canvas id="efficiencyChart"></canvas>
        </div>
    </div>
    
    <!-- Map -->
    <div class="chart-card">
        <div class="chart-title">
            <div class="chart-icon">üó∫Ô∏è</div>
            Route Map with Heatmap
        </div>
        <div id="map"></div>
    </div>
    
    <!-- Insights -->
    <div class="insights-container">
        <h3 style="margin-bottom: 20px; color: #333;">üìä Trip Insights</h3>
        <div id="insights">
            <div class="insight-item">
                <div class="insight-title">Route Efficiency</div>
                <div class="insight-text">Your route was 92% efficient compared to the shortest path</div>
            </div>
            <div class="insight-item">
                <div class="insight-title">Speed Pattern</div>
                <div class="insight-text">Maintained consistent speed for 75% of the journey</div>
            </div>
            <div class="insight-item">
                <div class="insight-title">Eco-Driving Score</div>
                <div class="insight-text">Smooth acceleration and deceleration patterns detected</div>
            </div>
        </div>
    </div>
    
    <script>
        // Chart configurations
        const chartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                }
            }
        };
        
        // Initialize map
        const map = L.map('map').setView([9.9312, 76.2673], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);
        
        let routeLine = null;
        let heatmapLayer = null;
        let markers = [];
        
        // GPS tracking variables
        let isTracking = false;
        let gpsData = [];
        let currentStats = {
            speed: 0,
            distance: 0,
            duration: 0,
            stops: 0,
            avgSpeed: 0,
            maxSpeed: 0,
            ecoScore: 85
        };
        
        // Initialize charts
        const speedChart = new Chart(document.getElementById('speedChart'), {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Speed (km/h)',
                    data: [],
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                ...chartOptions,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Speed (km/h)'
                        }
                    }
                }
            }
        });
        
        const speedZonesChart = new Chart(document.getElementById('speedZonesChart'), {
            type: 'doughnut',
            data: {
                labels: ['Stopped', 'Slow', 'Medium', 'Fast', 'Very Fast'],
                datasets: [{
                    data: [10, 25, 40, 20, 5],
                    backgroundColor: [
                        '#ff4444',
                        '#ffaa00',
                        '#00aa00',
                        '#0088ff',
                        '#aa00ff'
                    ]
                }]
            },
            options: chartOptions
        });
        
        const distanceChart = new Chart(document.getElementById('distanceChart'), {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Distance (km)',
                    data: [],
                    borderColor: '#4ecdc4',
                    backgroundColor: 'rgba(78, 205, 196, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                ...chartOptions,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Distance (km)'
                        }
                    }
                }
            }
        });
        
        const elevationChart = new Chart(document.getElementById('elevationChart'), {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Elevation (m)',
                    data: [],
                    borderColor: '#ff9800',
                    backgroundColor: 'rgba(255, 152, 0, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                ...chartOptions,
                scales: {
                    y: {
                        title: {
                            display: true,
                            text: 'Elevation (m)'
                        }
                    }
                }
            }
        });
        
        const accelerationChart = new Chart(document.getElementById('accelerationChart'), {
            type: 'scatter',
            data: {
                datasets: [{
                    label: 'Acceleration',
                    data: [],
                    backgroundColor: '#ff6b6b',
                    borderColor: '#ff6b6b'
                }, {
                    label: 'Deceleration',
                    data: [],
                    backgroundColor: '#4ecdc4',
                    borderColor: '#4ecdc4'
                }]
            },
            options: {
                ...chartOptions,
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Time'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Acceleration (m/s¬≤)'
                        }
                    }
                }
            }
        });
        
        const efficiencyChart = new Chart(document.getElementById('efficiencyChart'), {
            type: 'radar',
            data: {
                labels: ['Route', 'Speed', 'Eco', 'Time', 'Fuel', 'Safety'],
                datasets: [{
                    label: 'Current Trip',
                    data: [85, 75, 90, 80, 85, 95],
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.2)'
                }, {
                    label: 'Average',
                    data: [70, 70, 70, 70, 70, 70],
                    borderColor: '#ccc',
                    backgroundColor: 'rgba(200, 200, 200, 0.1)'
                }]
            },
            options: {
                ...chartOptions,
                scales: {
                    r: {
                        beginAtZero: true,
                        max: 100
                    }
                }
            }
        });
        
        // Start GPS tracking
        function startGPSTracking() {
            if (isTracking) return;
            
            isTracking = true;
            gpsData = [];
            
            if ('geolocation' in navigator) {
                navigator.geolocation.watchPosition(
                    processGPSData,
                    handleError,
                    { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 }
                );
                
                alert('GPS tracking started! Move around to see real-time updates.');
            } else {
                alert('Geolocation is not supported by your browser');
                simulateTrip(); // Fallback to simulation
            }
        }
        
        // Process GPS data
        function processGPSData(position) {
            const point = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
                speed: position.coords.speed || 0,
                accuracy: position.coords.accuracy,
                altitude: position.coords.altitude,
                timestamp: Date.now()
            };
            
            gpsData.push(point);
            updateRealTimeDisplay(point);
            updateCharts();
            updateMap();
        }
        
        // Handle GPS errors
        function handleError(error) {
            console.error('GPS Error:', error);
            if (error.code === 1) {
                alert('GPS permission denied. Using simulation mode.');
                simulateTrip();
            }
        }
        
        // Stop GPS tracking
        function stopGPSTracking() {
            isTracking = false;
            alert('GPS tracking stopped');
        }
        
        // Simulate a trip for demo
        function simulateTrip() {
            isTracking = true;
            gpsData = [];
            
            // Kerala route simulation (Kochi area)
            const baseRoute = [
                { lat: 9.9312, lng: 76.2673 },
                { lat: 9.9412, lng: 76.2773 },
                { lat: 9.9512, lng: 76.2873 },
                { lat: 9.9612, lng: 76.2973 },
                { lat: 9.9712, lng: 76.3073 },
                { lat: 9.9812, lng: 76.3173 },
                { lat: 9.9912, lng: 76.3273 },
                { lat: 10.0012, lng: 76.3373 },
                { lat: 10.0112, lng: 76.3473 },
                { lat: 10.0149, lng: 76.3511 }
            ];
            
            let index = 0;
            const interval = setInterval(() => {
                if (index >= baseRoute.length) {
                    clearInterval(interval);
                    isTracking = false;
                    generateAnalytics();
                    return;
                }
                
                const point = {
                    ...baseRoute[index],
                    speed: 20 + Math.random() * 40,
                    accuracy: 5 + Math.random() * 10,
                    altitude: 10 + Math.random() * 50,
                    timestamp: Date.now()
                };
                
                gpsData.push(point);
                updateRealTimeDisplay(point);
                updateCharts();
                updateMap();
                
                index++;
            }, 1000);
        }
        
        // Update real-time display
        function updateRealTimeDisplay(point) {
            const speedKmh = (point.speed * 3.6).toFixed(1);
            document.getElementById('currentSpeed').textContent = speedKmh;
            document.getElementById('gpsAccuracy').textContent = `¬±${Math.round(point.accuracy)}`;
            
            if (gpsData.length > 1) {
                const distance = calculateTotalDistance();
                document.getElementById('totalDistance').textContent = distance.toFixed(2);
                
                const duration = (Date.now() - gpsData[0].timestamp) / 60000;
                document.getElementById('duration').textContent = Math.floor(duration);
                
                const avgSpeed = calculateAverageSpeed();
                document.getElementById('avgSpeed').textContent = avgSpeed.toFixed(1);
            }
        }
        
        // Update charts with new data
        function updateCharts() {
            if (gpsData.length < 2) return;
            
            // Update speed chart
            const labels = gpsData.map((_, i) => i);
            const speeds = gpsData.map(p => (p.speed * 3.6).toFixed(1));
            
            speedChart.data.labels = labels;
            speedChart.data.datasets[0].data = speeds;
            speedChart.update();
            
            // Update distance chart
            const distances = [];
            let cumDistance = 0;
            for (let i = 1; i < gpsData.length; i++) {
                cumDistance += haversineDistance(
                    gpsData[i-1].lat, gpsData[i-1].lng,
                    gpsData[i].lat, gpsData[i].lng
                );
                distances.push((cumDistance / 1000).toFixed(2));
            }
            
            distanceChart.data.labels = labels.slice(1);
            distanceChart.data.datasets[0].data = distances;
            distanceChart.update();
            
            // Update elevation chart if available
            if (gpsData[0].altitude) {
                const elevations = gpsData.map(p => p.altitude || 0);
                elevationChart.data.labels = labels;
                elevationChart.data.datasets[0].data = elevations;
                elevationChart.update();
            }
            
            // Update speed zones
            updateSpeedZones();
            
            // Update acceleration chart
            updateAccelerationChart();
        }
        
        // Update speed zones distribution
        function updateSpeedZones() {
            const speeds = gpsData.map(p => p.speed * 3.6);
            const zones = [0, 0, 0, 0, 0]; // stopped, slow, medium, fast, very fast
            
            speeds.forEach(speed => {
                if (speed < 2) zones[0]++;
                else if (speed < 20) zones[1]++;
                else if (speed < 50) zones[2]++;
                else if (speed < 80) zones[3]++;
                else zones[4]++;
            });
            
            speedZonesChart.data.datasets[0].data = zones;
            speedZonesChart.update();
        }
        
        // Update acceleration chart
        function updateAccelerationChart() {
            if (gpsData.length < 3) return;
            
            const accelerations = [];
            const decelerations = [];
            
            for (let i = 2; i < gpsData.length; i++) {
                const v1 = gpsData[i-1].speed || 0;
                const v2 = gpsData[i].speed || 0;
                const dt = (gpsData[i].timestamp - gpsData[i-1].timestamp) / 1000;
                
                if (dt > 0) {
                    const acc = (v2 - v1) / dt;
                    if (acc > 0.5) {
                        accelerations.push({ x: i, y: acc });
                    } else if (acc < -0.5) {
                        decelerations.push({ x: i, y: Math.abs(acc) });
                    }
                }
            }
            
            accelerationChart.data.datasets[0].data = accelerations;
            accelerationChart.data.datasets[1].data = decelerations;
            accelerationChart.update();
        }
        
        // Update map with route
        function updateMap() {
            if (gpsData.length < 2) return;
            
            // Clear previous route
            if (routeLine) map.removeLayer(routeLine);
            markers.forEach(m => map.removeLayer(m));
            markers = [];
            
            // Draw route line
            const coordinates = gpsData.map(p => [p.lat, p.lng]);
            routeLine = L.polyline(coordinates, {
                color: '#667eea',
                weight: 3,
                opacity: 0.8
            }).addTo(map);
            
            // Add start marker
            const startMarker = L.marker(coordinates[0], {
                icon: L.divIcon({
                    className: 'custom-div-icon',
                    html: "<div style='background: #4caf50; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;'>S</div>"
                })
            }).addTo(map);
            markers.push(startMarker);
            
            // Add current position marker
            const currentMarker = L.marker(coordinates[coordinates.length - 1], {
                icon: L.divIcon({
                    className: 'custom-div-icon',
                    html: "<div style='background: #ff5722; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;'>üìç</div>"
                })
            }).addTo(map);
            markers.push(currentMarker);
            
            // Add heatmap layer
            if (heatmapLayer) map.removeLayer(heatmapLayer);
            const heatData = gpsData.map(p => [p.lat, p.lng, 0.5]);
            heatmapLayer = L.heatLayer(heatData, { radius: 25 }).addTo(map);
            
            // Fit map to route
            map.fitBounds(routeLine.getBounds());
        }
        
        // Calculate total distance
        function calculateTotalDistance() {
            if (gpsData.length < 2) return 0;
            
            let total = 0;
            for (let i = 1; i < gpsData.length; i++) {
                total += haversineDistance(
                    gpsData[i-1].lat, gpsData[i-1].lng,
                    gpsData[i].lat, gpsData[i].lng
                );
            }
            return total / 1000; // Convert to km
        }
        
        // Calculate average speed
        function calculateAverageSpeed() {
            if (gpsData.length === 0) return 0;
            const speeds = gpsData.map(p => p.speed * 3.6);
            return speeds.reduce((a, b) => a + b, 0) / speeds.length;
        }
        
        // Haversine distance formula
        function haversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000; // Earth's radius in meters
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        // Generate comprehensive analytics
        function generateAnalytics() {
            if (gpsData.length < 2) {
                alert('Not enough GPS data to generate analytics');
                return;
            }
            
            const analytics = {
                totalDistance: calculateTotalDistance(),
                averageSpeed: calculateAverageSpeed(),
                maxSpeed: Math.max(...gpsData.map(p => p.speed * 3.6)),
                duration: (gpsData[gpsData.length-1].timestamp - gpsData[0].timestamp) / 60000,
                stops: detectStops(),
                efficiency: calculateEfficiency()
            };
            
            // Update display
            document.getElementById('totalDistance').textContent = analytics.totalDistance.toFixed(2);
            document.getElementById('avgSpeed').textContent = analytics.averageSpeed.toFixed(1);
            document.getElementById('duration').textContent = Math.floor(analytics.duration);
            document.getElementById('stops').textContent = analytics.stops;
            document.getElementById('ecoScore').textContent = analytics.efficiency;
            
            // Update insights
            generateInsights(analytics);
            
            alert(`Analytics Generated!\n
Total Distance: ${analytics.totalDistance.toFixed(2)} km
Average Speed: ${analytics.averageSpeed.toFixed(1)} km/h
Max Speed: ${analytics.maxSpeed.toFixed(1)} km/h
Duration: ${Math.floor(analytics.duration)} minutes
Stops: ${analytics.stops}
Efficiency Score: ${analytics.efficiency}/100`);
        }
        
        // Detect stops in the trip
        function detectStops() {
            let stops = 0;
            let stationary = false;
            
            for (let i = 1; i < gpsData.length; i++) {
                const speed = gpsData[i].speed * 3.6;
                if (speed < 2 && !stationary) {
                    stops++;
                    stationary = true;
                } else if (speed > 5) {
                    stationary = false;
                }
            }
            return stops;
        }
        
        // Calculate efficiency score
        function calculateEfficiency() {
            const avgSpeed = calculateAverageSpeed();
            const stops = detectStops();
            
            let score = 100;
            
            // Deduct for too many stops
            score -= stops * 2;
            
            // Deduct for very high speed
            if (avgSpeed > 80) score -= 20;
            else if (avgSpeed > 60) score -= 10;
            
            // Bonus for moderate speed
            if (avgSpeed > 30 && avgSpeed < 50) score += 10;
            
            return Math.max(0, Math.min(100, score));
        }
        
        // Generate insights
        function generateInsights(analytics) {
            const insights = [];
            
            if (analytics.efficiency > 80) {
                insights.push({
                    title: 'Excellent Efficiency',
                    text: 'Your driving pattern shows excellent fuel efficiency and eco-friendly behavior'
                });
            }
            
            if (analytics.stops > 5) {
                insights.push({
                    title: 'Multiple Stops Detected',
                    text: `You made ${analytics.stops} stops during this trip. Consider route optimization.`
                });
            }
            
            if (analytics.averageSpeed > 60) {
                insights.push({
                    title: 'High Speed Travel',
                    text: 'Your average speed was above 60 km/h. Highway or express route detected.'
                });
            }
            
            const insightsContainer = document.getElementById('insights');
            insightsContainer.innerHTML = insights.map(insight => `
                <div class="insight-item">
                    <div class="insight-title">${insight.title}</div>
                    <div class="insight-text">${insight.text}</div>
                </div>
            `).join('');
        }
        
        // Export report
        function exportReport() {
            if (gpsData.length < 2) {
                alert('No data to export');
                return;
            }
            
            const report = {
                timestamp: new Date().toISOString(),
                analytics: {
                    totalDistance: calculateTotalDistance(),
                    averageSpeed: calculateAverageSpeed(),
                    maxSpeed: Math.max(...gpsData.map(p => p.speed * 3.6)),
                    duration: (gpsData[gpsData.length-1].timestamp - gpsData[0].timestamp) / 60000,
                    stops: detectStops(),
                    efficiency: calculateEfficiency()
                },
                gpsData: gpsData
            };
            
            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `gps-analytics-${Date.now()}.json`;
            a.click();
        }
        
        // Initialize dashboard
        window.onload = function() {
            // Set initial values
            document.getElementById('satellites').textContent = Math.floor(5 + Math.random() * 10);
            
            // Auto-start simulation for demo
            setTimeout(() => {
                if (confirm('Would you like to see a demo with simulated GPS data?')) {
                    simulateTrip();
                }
            }, 1000);
        };
    </script>
</body>
</html>